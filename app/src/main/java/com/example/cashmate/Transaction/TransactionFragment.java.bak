package com.example.cashmate.Transaction;

import android.database.Cursor;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import com.example.cashmate.R;
import com.example.cashmate.database.transaction.TransactionHandle;

import java.util.Calendar;

public class TransactionFragment extends Fragment {

    private RecyclerView rvTransactions;
    private TransactionAdapter adapter;
    private TransactionHandle transactionHandle;
    private com.example.cashmate.database.User.UserHandle userHandle;

    // ===== UI =====
    private TextView tvBalance;
    private TextView tvCurrentMonth, tvCurrentYear;
    private TextView tvStartBalance, tvEndBalance, tvTotal;
    private TextView btnPreviousMonth, btnNextMonth;

    // ===== THÁNG HIỆN TẠI =====
    private int currentMonth;
    private int currentYear;

    @Nullable
    @Override
    public View onCreateView(
            @NonNull LayoutInflater inflater,
            @Nullable ViewGroup container,
            @Nullable Bundle savedInstanceState
    ) {
        View view = inflater.inflate(R.layout.transaction, container, false);

        // ================= INIT VIEW =================
        tvBalance = view.findViewById(R.id.tvBalance);

        tvCurrentMonth = view.findViewById(R.id.tvCurrentMonth);
        tvCurrentYear  = view.findViewById(R.id.tvCurrentYear);

        tvStartBalance = view.findViewById(R.id.tvStartBalance);
        tvEndBalance   = view.findViewById(R.id.tvEndBalance);
        tvTotal        = view.findViewById(R.id.tvTotal);

        btnPreviousMonth = view.findViewById(R.id.btnPreviousMonth);
        btnNextMonth     = view.findViewById(R.id.btnNextMonth);

        // ================= RECYCLERVIEW =================
        rvTransactions = view.findViewById(R.id.rvTransactions);
        rvTransactions.setLayoutManager(new LinearLayoutManager(getContext()));

        transactionHandle = new TransactionHandle(getContext());
        userHandle = new com.example.cashmate.database.User.UserHandle(getContext());

        // ✅ Adapter rỗng – load theo tháng
        adapter = new TransactionAdapter(null);
        rvTransactions.setAdapter(adapter);

        // ================= INIT THÁNG HIỆN TẠI =================
        Calendar calendar = Calendar.getInstance();
        currentMonth = calendar.get(Calendar.MONTH) + 1; // MONTH bắt đầu từ 0
        currentYear  = calendar.get(Calendar.YEAR);

        updateMonthUI();
        loadDataByMonth();

        // ================= CLICK ĐỔI THÁNG =================
        btnPreviousMonth.setOnClickListener(v -> {
            currentMonth--;
            if (currentMonth == 0) {
                currentMonth = 12;
                currentYear--;
            }
            updateMonthUI();
            loadDataByMonth();
        });

        btnNextMonth.setOnClickListener(v -> {
            currentMonth++;
            if (currentMonth == 13) {
                currentMonth = 1;
                currentYear++;
            }
            updateMonthUI();
            loadDataByMonth();
        });

        // ================= BUTTON XEM BÁO CÁO =================
        Button btnViewReport = view.findViewById(R.id.btnViewReport);
        btnViewReport.setOnClickListener(v ->
                requireActivity().getSupportFragmentManager()
                        .beginTransaction()
                        .replace(R.id.fragment_container, new TransactionDetailsFragment())
                        .addToBackStack(null)
                        .commit()
        );

        return view;
    }

    @Override
    public void onResume() {
        super.onResume();
        // reload khi thêm / sửa giao dịch
        loadDataByMonth();
    }

    @Override
    public void onDestroyView() {
        super.onDestroyView();
        if (adapter != null) {
            adapter.swapCursor(null);
        }
    }

    // ================= UPDATE UI THÁNG =================
    private void updateMonthUI() {
        tvCurrentMonth.setText("Tháng " + currentMonth);
        tvCurrentYear.setText(String.valueOf(currentYear));
    }

    // ================= LOAD DATA THEO THÁNG =================
    private void loadDataByMonth() {

        // 1️⃣ RecyclerView
        Cursor cursor = transactionHandle.getByMonth(currentMonth, currentYear);
        adapter.swapCursor(cursor);

        // 2️⃣ Tổng thu / chi
        double income  = transactionHandle.getTotalByMonth(currentMonth, currentYear, "INCOME");
        double expense = transactionHandle.getTotalByMonth(currentMonth, currentYear, "EXPENSE");

        // 3️⃣ Số dư đầu & cuối
        double startBalance = transactionHandle.getStartBalance(currentMonth, currentYear);
        double endBalance   = startBalance + income - expense;

        // 4️⃣ Gán UI
        tvStartBalance.setText(String.format("%,.0f đ", startBalance));
        tvEndBalance.setText(String.format("%,.0f đ", endBalance));
        tvTotal.setText(String.format("%+.0f đ", income - expense));

        // SỐ DƯ TRÊN CÙNG = SỐ DƯ CUỐI
        tvBalance.setText(String.format("%,.0f đ", endBalance));
    }
}
